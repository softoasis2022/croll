import firebase_admin
from firebase_admin import credentials
from firebase_admin import db

from datetime import datetime



import random
import time
from datetime import datetime
import requests
from bs4 import BeautifulSoup
import bs4
from bs4 import BeautifulSoup as bs

from selenium import webdriver
from selenium import common
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.support.wait import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
#셀레니움 4버전 적용

cred = credentials.Certificate('softoasis-763c2-firebase-adminsdk-lhap2-28da23a1b3.json')

firebase_admin.initialize_app(cred,{
'databaseURL' : 'https://softoasis-763c2-default-rtdb.firebaseio.com/'
#'databaseURL' : '데이터 베이스 url'
})


def croll_naverspace_map(): #off
    
    for i in f:
        driver = webdriver.Chrome()
        driver.get('https://www.naver.com')

        query = driver.find_element(By.ID,'query')

        #검색창 초기화
        query.clear()
        query.send_keys(i + '카페')
        #검색버튼 클릭
        driver.find_element(By.CLASS_NAME,"btn_search").click()
        html = requests.get(driver.current_url)
        soup = html.text
        soup = bs4.BeautifulSoup(soup,'html.parser')
        for href in soup.find("div", class_="api_more_wrap").find_all("a"): # a테그 찾기
            driver.get(href["href"]) #a테그에 있는링크를 화면으로 변경 
        #장소 이름만 가지고 오기
        #https://map.naver.com/p/search/%EB%8C%80%EC%A0%84%EC%B9%B4%ED%8E%98?c=10.00,0,0,0,dh  로드된 페이지
        html = requests.get(driver.current_url)
        print(html.text)

def croll_naver_surchkw_view_model(kwString): #str / 뷰 모델 크롤링
    driver = webdriver.Chrome()
    driver.get('https://www.naver.com')

    query = driver.find_element(By.ID,'query')

    #검색창 초기화
    query.clear()
    query.send_keys(kwString)
    #검색버튼 클릭
    driver.find_element(By.CLASS_NAME,"btn_search").click()
    html = requests.get(driver.current_url)
    soup = html.text
    soup = bs4.BeautifulSoup(soup,'html.parser')
    #검색 완료
    url = []
    urltext = []
    for href1 in soup.find_all("div",class_ = 'api_more_wrap'): # 테그 찾기
        soup1 = bs4.BeautifulSoup(str(href1),'html.parser')
        soup1 = soup1.find("a")
        urlstring = str(soup1['href'])
        if(urlstring[0] != "?" and urlstring[0] != "#"):
            url.append(urlstring)
            urltext.append(soup1.text)
        '''
        print(soup1.text)
        print(urlstring)
        '''
    for href2 in soup.find("section","sc_new sp_nkeyword"):
        page_text = str(href2)
        soup1 =bs4.BeautifulSoup(page_text,'html.parser')
        if(type(soup1) != type(None)):
            for kw in soup1.find_all("a"):
                space_kw = str(kw)
                soup2 =bs4.BeautifulSoup(space_kw,'html.parser')
                htmlkw = soup2.find("div","tit")
                if(type(htmlkw) != type(None)):
                    f2.append(htmlkw.text)
                    print(htmlkw.text)
                    firebase(htmlkw.text)
        
        
    '''  
    for k in range(len(li_space)):  #스페이스 갯수,스페이스 이름
        space = bs4.BeautifulSoup(str(li_space[k]),'html.parser')
        print(space.find('a').text)
        #'더보기' 문자열 제거
        stringdata = space.find('a').text
        space_more_url.append(stringdata)
    '''

    '''
    for j in li:
        listr = str(j)
        print('타입 : '+str(type(listr)))
        print('변환된 텍스트 : ' + listr)
        soup = bs4.BeautifulSoup(listr,'html.parser')
        for k in soup.find_all("a"):
            print(k["href"])
    ''' 

def firebase(kw):
    firebaseref = db.reference('main') #서버 컨트롤 onoff코드
    firebaseref.child('키워드').push().set(kw)


f1= ['카페']
f2 = []

while(f1 != None):
    for input_kw in f1:
        croll_naver_surchkw_view_model(input_kw)
        f1.remove(input_kw)
    f1=f2

    # f1 키워드 삭제 코드
    
    
